<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RASPADITA TEAM L-5</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@800;900&family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<style>
  body{margin:0;font-family:Inter,sans-serif;background:#0b0f1a;color:#fff;text-align:center}
  .bg{position:fixed;inset:0;z-index:-1;background:url("f1ec4f7e-3b11-414c-bb1c-3db302c97c66.jpg") center/cover no-repeat}
  h1{font-family:Orbitron,sans-serif;font-size:clamp(28px,6vw,52px);margin:20px 0;
     color:#ff1b1b;text-shadow:0 0 8px #fff,0 0 18px #ff1b1b;}
  .card{background:rgba(0,0,0,.6);border-radius:16px;padding:20px;max-width:480px;margin:0 auto}
  #premio{font-size:22px;font-weight:bold;margin:20px 0;color:#ffd86b}
  #stamp{font-size:14px;color:#cdd6ea;display:none}
  #scratch{width:100%;height:200px;border-radius:12px;background:#999;margin-top:10px}
  .btn{display:none;margin-top:12px;padding:12px 20px;border:none;border-radius:30px;
       font-weight:bold;background:linear-gradient(90deg,#00d5ff,#7b5cff);color:#000;cursor:pointer}
  .hint{font-size:14px;color:#aaa;margin-top:10px}
</style>
</head>
<body>
<div class="bg"></div>
<h1>RASPADITA TEAM L-5</h1>

<div class="card" id="card">
  <div id="premio">üéÅ Cargando premio...</div>
  <canvas id="scratch"></canvas>
  <div id="stamp"></div>
  <button id="whatsappBtn" class="btn">üì≤ Enviar captura por WhatsApp</button>
  <div class="hint" id="hint">Rasp√° con el dedo o el mouse</div>
</div>

<script>
const card=document.getElementById("card");
const canvas=document.getElementById("scratch");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const premio=document.getElementById("premio");
const waBtn=document.getElementById("whatsappBtn");
const stamp=document.getElementById("stamp");
const hintEl=document.getElementById("hint");

let currentWin=false,currentStampText="";
const RESULT_KEY="raspadita:result:"+new Date().toISOString().slice(0,10);

// ===== Cargar resultado guardado (segunda vez del d√≠a) =====
function init(){
  const cached=localStorage.getItem(RESULT_KEY);
  if(cached){
    const data=JSON.parse(cached);
    currentWin=!!data.win;
    currentStampText=data.stampText||"";
    canvas.style.display="none";

    if(currentWin){
      premio.innerHTML=data.mensajeHTML??data.mensaje;
      stamp.textContent=currentStampText;
      stamp.style.display="inline-block";
      waBtn.style.display="inline-block";
      hintEl.textContent="‚è≥ Ya jugaste hoy. Volv√© ma√±ana.";
    }else{
      // üëá Nuevo mensaje en recarga
      premio.innerHTML=`‚è≥ Ya probaste hoy a esta hora üëá<br><small style="color:#cdd6ea">${currentStampText}</small>`;
      stamp.textContent=currentStampText;
      stamp.style.display="inline-block";
      waBtn.style.display="none";
      hintEl.textContent="‚è≥ Ya probaste hoy a esta hora üëá";
    }
    return;
  }
  prepararPremio();
}

// ===== Generar premio desde backend =====
async function prepararPremio(){
  try{
    const r=await fetch("/api/sorteo",{method:"POST",headers:{"Content-Type":"application/json"}});
    const data=await r.json();
    if(!data.ok) throw new Error(data.error||"error");

    const fecha=new Date().toLocaleString("es-AR",{timeZone:"America/Argentina/Buenos_Aires"});
    const codigo=Math.random().toString(36).substring(2,10).toUpperCase();
    currentStampText=`Emitido: ${fecha} ‚Ä¢ C√≥digo: ${codigo}`;

    currentWin=/ganaste/i.test(data.mensaje);
    if(currentWin){
      premio.innerHTML=`üéâ ${data.mensaje}<br><small style="color:#cdd6ea">${currentStampText}</small>`;
      waBtn.style.display="inline-block";
    }else{
      premio.innerHTML=`üòÖ Sin premio esta vez. Prob√° ma√±ana.<br><small style="color:#cdd6ea">${currentStampText}</small>`;
      waBtn.style.display="none";
    }
    stamp.textContent=currentStampText;
    stamp.style.display="inline-block";

    localStorage.setItem(RESULT_KEY,JSON.stringify({
      mensaje:data.mensaje,
      mensajeHTML:premio.innerHTML,
      win:currentWin,
      stampText:currentStampText
    }));
  }catch(e){
    premio.textContent="‚ö†Ô∏è Error al cargar premio";
  }
}

// ===== Raspado b√°sico =====
function size(){
  const w=canvas.clientWidth,h=canvas.clientHeight;
  canvas.width=w;canvas.height=h;
  ctx.fillStyle="#999";ctx.fillRect(0,0,w,h);
  ctx.fillStyle="#000";ctx.font="bold 20px Inter";ctx.textAlign="center";ctx.textBaseline="middle";
  ctx.fillText("Rasp√° aqu√≠",w/2,h/2);
}
size();

let drawing=false;
canvas.addEventListener("pointerdown",e=>{drawing=true;scratch(e)});
canvas.addEventListener("pointermove",scratch);
canvas.addEventListener("pointerup",()=>drawing=false);

function scratch(e){
  if(!drawing)return;
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left,y=e.clientY-rect.top;
  ctx.globalCompositeOperation="destination-out";
  ctx.beginPath();ctx.arc(x,y,30,0,Math.PI*2);ctx.fill();
}

// ===== WhatsApp =====
const WHATSAPP_NUMBER="5491167907135";
waBtn.addEventListener("click",async()=>{
  if(!currentWin) return;
  const mensaje=`¬°Hola! Acabo de ganar en la RASPADITA TEAM L-5: ${premio.textContent.trim()}`;
  const waURL=`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
  window.open(waURL,"_blank");
});

document.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
