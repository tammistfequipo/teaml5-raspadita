<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RASPADITA TEAM L-5</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@800;900&family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<style>
  :root{
    --bg-url: url("f1ec4f7e-3b11-414c-bb1c-3db302c97c66.jpg");
    --glass: rgba(10,14,25,.55);
    --accent: #00d5ff;
    --accent-2: #7b5cff;
    --gold: #ffd86b;
    --muted: #a8b1c3;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; color:#eaf2ff; font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f1a;}
  .bg{position:fixed; inset:0; z-index:-2; background: var(--bg-url) center/cover no-repeat fixed; filter:brightness(.9) saturate(1.05)}
  .bg::after{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(8,10,18,.55), rgba(8,10,18,.78)); backdrop-filter: blur(2px)}

  .wrap{min-height:100%; display:grid; place-items:center; padding:28px}
  .stack{width:min(520px, 92vw); margin-inline:auto}

  h1{
    margin:0 0 18px; text-align:center;
    font-family: Orbitron, Inter, system-ui, sans-serif; font-weight:900; letter-spacing:1px;
    font-size:clamp(28px, 6vw, 52px);
    color:#ff1a1a;
    -webkit-text-stroke:1px #fff;
    text-shadow:0 0 5px #ff1a1a,0 0 10px #ff1a1a,0 0 20px #ff1a1a,0 0 40px #ff0000,0 0 80px #ff0000;
    animation: popIn .9s cubic-bezier(.2,1,.2,1) both, neonBlink 2s infinite;
  }
  @keyframes popIn{0%{transform:scale(.2);opacity:0}70%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}
  @keyframes neonBlink{
    0%,100%{text-shadow:0 0 5px #ff1a1a,0 0 10px #ff1a1a,0 0 20px #ff1a1a,0 0 40px #ff0000,0 0 80px #ff0000}
    50%{text-shadow:0 0 2px #ff1a1a,0 0 6px #ff3333,0 0 12px #ff3333,0 0 24px #ff1a1a}
  }

  .card{
    position:relative; overflow:visible;
    background: var(--glass);
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px; padding:22px;
    box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
    backdrop-filter: blur(6px);
  }

  .prize-wrap{
    position:relative; width:100%; height:240px; border-radius:14px; overflow:hidden;
    border:1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.35); isolation:isolate;
  }
  #premio{
    position:absolute; inset:0; display:grid; place-items:center; padding:12px;
    font-weight:800; font-size:clamp(20px,4.8vw,28px); color:var(--gold); text-align:center;
    text-shadow:0 2px 0 rgba(0,0,0,.8), 0 0 14px rgba(255,216,107,.35);
  }
  .stamp{
    position:absolute; right:10px; bottom:8px;
    padding:6px 10px; font-size:12px; line-height:1.25;
    color:#eaf2ff; background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.18);
    border-radius:10px; backdrop-filter: blur(4px);
    box-shadow:0 4px 14px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    display:none;
  }

  #scratch{position:absolute; inset:0; display:block; border-radius:14px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.35), 0 0 22px rgba(0,0,0,.25); touch-action:none; clip-path: inset(0 round 14px)}

  .actions{display:flex; justify-content:center; margin-top:16px; gap:10px; flex-wrap:wrap}
  .btn{
    display:none; border:0; cursor:pointer; padding:12px 22px; border-radius:999px;
    font-weight:800; letter-spacing:.3px; background: radial-gradient(120% 120% at 0% 0%, var(--accent), var(--accent-2));
    color:#071018; box-shadow: 0 8px 22px rgba(0,213,255,.25); transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow:0 12px 28px rgba(0,213,255,.32) }
  .btn:active{ transform: translateY(1px); filter:brightness(.92) }

  .hint{color:#cbd3e6; text-align:center; margin-top:8px; font-size:14px}
  .hint.hidden{ display:none; }

  .confetti-layer{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:999; }
  .confetto{ position:absolute; width:10px; height:14px; border-radius:2px; opacity:.95 }
</style>
</head>
<body>
  <div class="bg"></div>

  <div class="wrap">
    <div class="stack">
      <h1> RASPADITA TEAM L-5 </h1>

      <div class="card" id="card">
        <div class="prize-wrap">
          <div id="premio">üéÅ Cargando premio...</div>
          <div id="stamp" class="stamp"></div>
          <canvas id="scratch"></canvas>
        </div>

        <div class="actions">
          <button id="whatsappBtn" class="btn">üì≤ Enviar captura por WhatsApp</button>
        </div>
        <div id="hint" class="hint">Rasp√° con el dedo o el mouse. Al revelar ~50% se bloquea la jugada de hoy.</div>
      </div>
    </div>
  </div>

  <div class="confetti-layer" id="confettiLayer"></div>

<script>
  /* ===== Reset r√°pido por URL: ?reset=1 ===== */
  (function(){
    const q = new URLSearchParams(location.search);
    if (q.get('reset') === '1') {
      const today = new Date().toISOString().slice(0,10);
      localStorage.removeItem('raspadita:result:' + today);
      location.replace(location.pathname);
    }
  })();

  const card   = document.getElementById('card');
  const canvas = document.getElementById('scratch');
  const ctx    = canvas.getContext('2d', { willReadFrequently: true });
  const premio = document.getElementById('premio');
  const stamp  = document.getElementById('stamp');
  const waBtn  = document.getElementById('whatsappBtn');
  const hintEl = document.getElementById('hint');
  const confettiLayer = document.getElementById('confettiLayer');

  let WA_NUMBER = ""; // se carga desde el backend en /api/sorteo
  const TODAY = new Date().toISOString().slice(0,10);
  const RESULT_KEY = 'raspadita:result:' + TODAY;

  let currentWin = false;
  let currentStampText = "";
  let revealed = false;

  function fechaHoraAR(){
    return new Date().toLocaleString("es-AR", { timeZone: "America/Argentina/Buenos_Aires" });
  }
  function genCode(len=6){
    return Math.random().toString(36).slice(2, 2+len).toUpperCase().replace(/O/g,'0').replace(/I/g,'1');
  }
  function isWinningMessage(text){ return /ganaste/i.test(text || ""); }

  // ID √∫nico por navegador
  function getClientId(){
    const k = 'raspadita:clientId';
    let id = localStorage.getItem(k);
    if (!id){
      id = 'cid_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem(k, id);
    }
    return id;
  }

  // Pide sorteo y (si viene) el n√∫mero de WhatsApp desde el backend
  async function pedirSorteo(){
    const r = await fetch('/api/sorteo', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ clientId: getClientId() })
    });
    const data = await r.json();
    if (!data.ok) throw new Error(data.error || 'error');
    if (data.whatsApp) WA_NUMBER = (data.whatsApp || "").toString();
    return data;
  }

  // Confetti
  function confetti(duracionMs = 5000, cantidad = 120){
    for(let i=0;i<cantidad;i++){
      const c = document.createElement('div');
      c.className='confetto';
      c.style.left = Math.random()*100 + 'vw';
      c.style.top  = '-12px';
      c.style.background = `hsl(${Math.random()*360}, 90%, 60%)`;
      const rot = (Math.random()*360)|0;
      const dur = duracionMs + Math.random()*1500;
      const dx  = (Math.random()*2-1)*160;
      c.animate([
        { transform:`translate(0,0) rotate(${rot}deg)`, opacity:1 },
        { transform:`translate(${dx}px, 100vh) rotate(${rot+360}deg)`, opacity:.9 }
      ], { duration:dur, easing:'ease-out', fill:'forwards' });
      confettiLayer.appendChild(c);
      setTimeout(()=>c.remove(), dur+150);
    }
  }

  /* === Setter SEGURO del mensaje (anti-XSS) === */
  function setSafePrizeMessage(msg, stampText) {
    premio.textContent = (msg || "").toString();
    if (stampText) {
      premio.appendChild(document.createElement('br'));
      const sm = document.createElement('small');
      sm.style.color = '#cdd6ea';
      sm.textContent = stampText;
      premio.appendChild(sm);
    }
  }

  // Carga inicial
  async function init(){
    const cached = localStorage.getItem(RESULT_KEY);
    if (cached){
      const data = JSON.parse(cached);
      currentWin = !!data.win;
      currentStampText = data.stampText || "";
      canvas.style.display = 'none';

      if (currentWin){
        setSafePrizeMessage(data.mensaje || "¬°GANASTE!", currentStampText);
        stamp.textContent = currentStampText;
        stamp.style.display = 'inline-block';
        waBtn.style.display = 'inline-block';
        hintEl.textContent = "‚è≥ Ya jugaste hoy. Volv√© ma√±ana.";
      } else {
        setSafePrizeMessage("üòÖ Sin premio esta vez. Prob√° ma√±ana.", currentStampText);
        stamp.textContent = currentStampText;
        stamp.style.display = 'inline-block';
        waBtn.style.display = 'none';
        hintEl.textContent = "‚è≥ Ya probaste hoy a esta hora ‚òùÔ∏è";
      }
      return;
    }

    // No hay cache ‚Üí preparar para raspar
    size();
    paintCover(canvas.clientWidth, canvas.clientHeight);
  }

  // Capa plateada y raspado
  const BRUSH=42, REVEAL_THRESHOLD=0.5;
  let drawing=false, last=null, lastCheck=0, dpr=1;

  function size(){
    const wrap=document.querySelector('.prize-wrap');
    const w=wrap.clientWidth, h=wrap.clientHeight;
    dpr=Math.max(1, window.devicePixelRatio||1);
    canvas.style.width=w+'px'; canvas.style.height=h+'px';
    canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function paintCover(w,h){
    ctx.globalCompositeOperation='source-over';
    const grad=ctx.createLinearGradient(0,0,w,h);
    grad.addColorStop(0,'#b7b7b7'); grad.addColorStop(1,'#9c9c9c');
    ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.font="bold 20px Inter, Arial";
    ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("Rasp√° aqu√≠", w/2, h/2);
    revealed=false; waBtn.style.display='none'; canvas.style.opacity=1; canvas.style.display='block';
  }
  function pos(e){ const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; }
  function scratch(e){
    if(!drawing || revealed) return;
    const {x,y}=pos(e);
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(x,y,BRUSH,0,Math.PI*2); ctx.fill();
    if(last){ ctx.lineWidth=BRUSH*2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(x,y); ctx.stroke(); }
    last={x,y}; throttleCheck();
  }
  const sample=document.createElement('canvas'); const sctx=sample.getContext('2d',{willReadFrequently:true}); sample.width=80; sample.height=50;
  function throttleCheck(){ const now=performance.now(); if(now-lastCheck<160)return; lastCheck=now; checkReveal(); }
  function checkReveal(){
    sctx.clearRect(0,0,sample.width,sample.height);
    sctx.drawImage(canvas,0,0,sample.width,sample.height);
    const {data}=sctx.getImageData(0,0,sample.width,sample.height);
    let transparent=0; for(let i=3;i<data.length;i+=4) if(data[i]===0) transparent++;
    const percent=transparent/(sample.width*sample.height);
    if(percent>=REVEAL_THRESHOLD && !revealed) reveal();
  }

  // Al revelar por primera vez
  async function reveal(){
    revealed=true;

    let sorteo;
    try{
      sorteo = await pedirSorteo();
    }catch(e){
      premio.textContent = "‚ö†Ô∏è Intentalo de nuevo en un momento.";
      return;
    }

    const codigo = (sorteo.code || genCode());
    const horaAR = fechaHoraAR();
    currentStampText = `Emitido: ${horaAR} ¬∑ C√≥digo: ${codigo}`;
    currentWin = isWinningMessage(sorteo.mensaje);

    if (currentWin){
      setSafePrizeMessage(sorteo.mensaje, currentStampText);
      stamp.textContent = currentStampText; stamp.style.display='inline-block';
      waBtn.style.display = 'inline-block';
      confetti(6000, 140);

      localStorage.setItem(RESULT_KEY, JSON.stringify({
        mensaje: sorteo.mensaje,
        win: true,
        stampText: currentStampText
      }));
    } else {
      setSafePrizeMessage("üòÖ Sin premio esta vez. Prob√° ma√±ana.", currentStampText);
      stamp.textContent = currentStampText; stamp.style.display='inline-block';
      waBtn.style.display = 'none';

      localStorage.setItem(RESULT_KEY, JSON.stringify({
        mensaje: "Sin premio",
        win: false,
        stampText: currentStampText
      }));
    }

    // Bloqueo visual
    canvas.style.transition='opacity .45s ease';
    canvas.style.opacity=0;
    setTimeout(()=> (canvas.style.display='none'), 470);
    hintEl.textContent = "‚è≥ Ya jugaste hoy. Volv√© ma√±ana.";
  }

  // Eventos pointer
  canvas.addEventListener('pointerdown', e=>{ canvas.setPointerCapture?.(e.pointerId); drawing=true; last=null; scratch(e); });
  canvas.addEventListener('pointermove', scratch);
  canvas.addEventListener('pointerup',   e=>{ canvas.releasePointerCapture?.(e.pointerId); drawing=false; last=null; });
  canvas.addEventListener('pointercancel',()=>{ drawing=false; last=null; });
  canvas.style.touchAction='none';

  // WhatsApp + captura
  async function captureCardBlob(){
    if (!window.html2canvas) return null;
    const cap = await html2canvas(card,{backgroundColor:null, scale:Math.min(window.devicePixelRatio||1,2), useCORS:true});
    return await new Promise(res=>cap.toBlob(res,'image/png',0.95));
  }
  function downloadBlob(blob,filename){
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
  }
  waBtn.addEventListener('click', async ()=>{
    if (!currentWin) return;
    const baseText = premio.textContent.replace(/\s+/g,' ').trim();
    const mensaje  = `¬°Hola! Acabo de ganar en la RASPADITA TEAM L-5: ${baseText} ‚Äî ${currentStampText}`;
    const waURL    = WA_NUMBER ? `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(mensaje)}` : null;

    const blob = await captureCardBlob();
    try{
      if (blob && navigator.canShare && navigator.canShare({ files: [new File([blob],'premio.png',{type:'image/png'})] })) {
        await navigator.share({ files:[new File([blob],'premio.png',{type:'image/png'})], title:'Premio RASPADITA TEAM L-5', text:mensaje });
        return;
      }
    }catch(e){ /* share fallback */ }

    if (blob) downloadBlob(blob,'premio.png');
    if (waURL) window.open(waURL,'_blank');
  });

  // Atajo admin: Shift+R limpia el resultado de hoy
  window.addEventListener('keydown', (e)=>{
    if (e.shiftKey && (e.key === 'R' || e.key === 'r')) {
      localStorage.removeItem(RESULT_KEY);
      location.reload();
    }
  });

  // Init
  window.addEventListener('resize', ()=>{ if (canvas.style.display !== 'none') { size(); paintCover(canvas.clientWidth, canvas.clientHeight); }});
  window.addEventListener('load', init);
  document.addEventListener('DOMContentLoaded', ()=>{ if (canvas.style.display !== 'none') { size(); paintCover(canvas.clientWidth, canvas.clientHeight); }});
</script>
</body>
</html>
