<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RASPADITA TEAM L-5</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@800;900&family=Inter:wght@400;700;800&display=swap" rel="stylesheet">

<!-- Captura de pantalla de elementos (para adjuntar en WhatsApp/descargar) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<style>
  :root{
    --bg-url: url("https://images.unsplash.com/photo-1520975922215-230f5a0627dd?q=80&w=1600&auto=format&fit=crop");
    --glass: rgba(10,14,25,.55);
    --accent: #00d5ff;
    --accent-2: #7b5cff;
    --gold: #ffd86b;
    --muted: #a8b1c3;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:#eaf2ff;
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    background:
      radial-gradient(1200px 600px at 70% -10%, rgba(255,60,120,.20), transparent 60%),
      radial-gradient(900px 500px at -10% 110%, rgba(0,213,255,.18), transparent 60%),
      #0b0f1a;
  }
  .bg{position:fixed; inset:0; z-index:-2; background: var(--bg-url) center/cover no-repeat fixed; filter:brightness(.85) saturate(1.05)}
  .bg::after{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(8,10,18,.55), rgba(8,10,18,.78)); backdrop-filter: blur(2px)}
  .wrap{min-height:100%; display:grid; place-items:center; padding:20px}
  .stack{width:min(520px, 92vw); margin-inline:auto}
  h1{
    margin:0 0 18px; text-align:center;
    font-family: Orbitron, Inter, system-ui, sans-serif; font-weight:900; letter-spacing:1px;
    font-size:clamp(28px, 6vw, 52px);
    background: linear-gradient(90deg, #fff, var(--gold), #fff);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    filter: drop-shadow(0 2px 0 #000) drop-shadow(0 0 12px rgba(0,0,0,.6));
    animation: popIn .9s cubic-bezier(.2,1,.2,1) both, blink 2.8s ease-in-out infinite .9s;
  }
  @keyframes popIn{0%{transform:scale(.2);opacity:0}70%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}
  @keyframes blink{0%,100%{filter:drop-shadow(0 2px 0 #000)}50%{filter:drop-shadow(0 0 18px rgba(255,216,107,.55))}}

  .card{
    position:relative; overflow:hidden;
    background: var(--glass);
    border:1px solid rgba(255,255,255,.08);
    border-radius: 18px;
    padding:18px;
    box-shadow: 0 10px 40px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
    backdrop-filter: blur(6px);
  }

  .prize-wrap{
    position:relative;
    width:100%;
    height:240px;
    border-radius:14px;
    overflow:hidden;
    isolation:isolate;
    border:1px solid rgba(255,255,255,.08);
    background:
      radial-gradient(60% 60% at 50% 40%, rgba(255,255,255,.06), transparent 60%),
      rgba(0,0,0,.35);
  }

  #premio{
    position:absolute; inset:0; display:grid; place-items:center;
    font-weight:800; font-size:clamp(20px,4.8vw,28px); color:var(--gold);
    text-shadow: 0 2px 0 rgba(0,0,0,.8), 0 0 14px rgba(255,216,107,.35);
    padding:10px; text-align:center;
  }

  #scratch{
    position:absolute; inset:0; display:block; border-radius:14px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.35), 0 0 22px rgba(0,0,0,.25);
    touch-action:none;
    clip-path: inset(0 round 14px);
  }

  .actions{
    display:flex; gap:10px; justify-content:center; margin-top:16px; flex-wrap:wrap;
  }
  .btn{
    border:0; cursor:pointer; padding:12px 18px; border-radius:999px;
    font-weight:800; letter-spacing:.3px; display:inline-flex; align-items:center; gap:8px;
    color:#071018; background: radial-gradient(120% 120% at 0% 0%, var(--accent), var(--accent-2));
    box-shadow: 0 8px 22px rgba(0,213,255,.25); transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow:0 12px 28px rgba(0,213,255,.32) }
  .btn:active{ transform: translateY(1px); filter:brightness(.92) }

  #whatsappBtn{ display:none }  /* Se habilita cuando revel치s ~50% */
  #downloadBtn{ display:none }  /* Se habilita junto con WhatsApp */

  .hint{color:var(--muted); text-align:center; margin-top:8px; font-size:14px}

  .confetti-layer{ position: fixed; inset:0; pointer-events:none; overflow:hidden; z-index: 999; }
  .confetto{position:absolute; width:10px; height:14px; border-radius:2px; opacity:.95}
</style>
</head>
<body>
  <div class="bg"></div>

  <div class="wrap">
    <div class="stack">
      <h1>游꿣 RASPADITA TEAM L-5 游꿣</h1>

      <div class="card" id="card">
        <div class="prize-wrap" id="prizeWrap">
          <div id="premio">游꾸 Ganaste 500 fichas</div>
          <canvas id="scratch"></canvas>
        </div>

        <div class="actions">
          <button id="whatsappBtn" class="btn">游 Enviar captura por WhatsApp</button>
          <button id="downloadBtn" class="btn" style="background:linear-gradient(90deg,#ffd86b,#fff0a6)">拘勇 Descargar captura</button>
        </div>
        <div class="hint">Rasp치 con el dedo o el mouse. Al revelar ~50% se habilitan los botones.</div>
      </div>
    </div>
  </div>

  <div class="confetti-layer" id="confettiLayer"></div>

<script>
  const canvas = document.getElementById('scratch');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const premio = document.getElementById('premio');
  const confettiLayer = document.getElementById('confettiLayer');
  const card = document.getElementById('card');
  const whatsappBtn = document.getElementById('whatsappBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  // ===== Ajustes =====
  const BRUSH = 46;
  const REVEAL_THRESHOLD = 0.5;
  const FOIL_URL = ""; // opcional: textura de raspado

  // N칰mero de WhatsApp (Argentina: 54 + 9 + 11 + l칤nea)
  const WHATSAPP_NUMBER = "5491167907135";

  let drawing = false, revealed = false, last = null, lastCheck = 0, dpr = 1, foilImg = null;

  function size(){
    const wrap = canvas.parentElement;
    const w = wrap.clientWidth;
    const h = wrap.clientHeight;
    dpr = Math.max(1, window.devicePixelRatio || 1);

    canvas.style.width  = w + 'px';
    canvas.style.height = h + 'px';
    canvas.width  = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    paintCover(w, h);
  }

  function paintCover(wcss, hcss){
    ctx.globalCompositeOperation = 'source-over';
    if (foilImg && foilImg.complete){
      const pattern = ctx.createPattern(foilImg, 'repeat');
      ctx.fillStyle = pattern;
      ctx.fillRect(0,0,wcss,hcss);
      const g = ctx.createLinearGradient(0,0,wcss,hcss);
      g.addColorStop(0,'rgba(0,0,0,.15)'); g.addColorStop(1,'rgba(255,255,255,.08)');
      ctx.fillStyle = g; ctx.fillRect(0,0,wcss,hcss);
    } else {
      const grad = ctx.createLinearGradient(0,0,wcss,hcss);
      grad.addColorStop(0, '#bfbfbf'); grad.addColorStop(1, '#9d9d9d');
      ctx.fillStyle = grad; ctx.fillRect(0,0,wcss,hcss);
    }
    ctx.fillStyle = 'rgba(0,0,0,.35)';
    ctx.font = "bold 20px Inter, Arial";
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText("Rasp치 aqu칤", wcss/2, hcss/2);

    ctx.globalCompositeOperation = 'source-over';
    canvas.style.opacity = 1;
    canvas.style.display = 'block';
    revealed = false;
    whatsappBtn.style.display = 'none';
    downloadBtn.style.display = 'none';
  }

  function pos(e){
    const r = canvas.getBoundingClientRect();
    const cx = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
    const cy = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
    return {x: cx, y: cy};
  }

  function scratch(e){
    if (!drawing || revealed) return;
    const {x,y} = pos(e);

    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath(); ctx.arc(x, y, BRUSH, 0, Math.PI*2); ctx.fill();

    if (last){
      ctx.lineWidth = BRUSH * 2;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(x, y);
      ctx.stroke();
    }
    last = {x, y};

    throttleCheck();
  }

  const sample = document.createElement('canvas');
  const sctx = sample.getContext('2d', { willReadFrequently: true });
  sample.width = 80; sample.height = 50;

  function throttleCheck(){
    const now = performance.now();
    if (now - lastCheck < 140) return;
    lastCheck = now;
    checkReveal();
  }

  function checkReveal(){
    sctx.clearRect(0,0,sample.width,sample.height);
    sctx.drawImage(canvas, 0, 0, sample.width, sample.height);
    const {data} = sctx.getImageData(0,0,sample.width,sample.height);
    let transparent = 0;
    for (let i=3; i<data.length; i+=4) if (data[i] === 0) transparent++;
    const percent = transparent / (sample.width*sample.height);
    if (percent >= REVEAL_THRESHOLD && !revealed) reveal();
  }

  function confetti(){
    for(let i=0;i<100;i++){
      const c = document.createElement('div');
      c.className='confetto';
      c.style.left = Math.random()*100 + 'vw';
      c.style.top = '-10px';
      c.style.background = `hsl(${Math.random()*360}, 90%, 60%)`;
      const rot = (Math.random()*360)|0;
      const dur = 6000 + Math.random()*2500;
      const dx  = (Math.random()*2-1)*120;
      c.animate([
        { transform:`translate(0,0) rotate(${rot}deg)`, opacity:1 },
        { transform:`translate(${dx}px, 100vh) rotate(${rot+360}deg)`, opacity:.9 }
      ], { duration:dur, easing:'ease-out', fill:'forwards' });
      confettiLayer.appendChild(c);
      setTimeout(()=>c.remove(), dur+200);
    }
  }

  function reveal(){
    revealed = true;
    canvas.style.transition = 'opacity .45s ease';
    canvas.style.opacity = 0;
    setTimeout(()=> (canvas.style.display='none'), 470);
    confetti();
    // Mostrar botones de acci칩n
    whatsappBtn.style.display = 'inline-flex';
    downloadBtn.style.display = 'inline-flex';
  }

  // Eventos pointer
  canvas.addEventListener('pointerdown', e=>{ canvas.setPointerCapture(e.pointerId); drawing = true; last = null; scratch(e); });
  canvas.addEventListener('pointermove', scratch);
  canvas.addEventListener('pointerup',   e=>{ canvas.releasePointerCapture?.(e.pointerId); drawing = false; last = null; });
  canvas.addEventListener('pointercancel',()=>{ drawing = false; last = null; });
  canvas.style.touchAction = 'none';

  // Carga opcional de foil
  function loadFoilAndSize(){
    if (FOIL_URL){
      foilImg = new Image();
      foilImg.crossOrigin = "anonymous";
      foilImg.onload = size;
      foilImg.onerror = size;
      foilImg.src = FOIL_URL;
    } else {
      foilImg = null;
      size();
    }
  }

  // ---- Captura de la tarjeta (PNG) ----
  async function captureCardBlob(){
    const node = card;
    // Espera a que html2canvas est칠 cargado
    if (!window.html2canvas) {
      alert("Cargando capturador, prob치 de nuevo en 1 seg.");
      return null;
    }
    const canvasCap = await html2canvas(node, {
      backgroundColor: null,
      scale: Math.min(window.devicePixelRatio || 1, 2), // calidad sin exagerar peso
      useCORS: true
    });
    return await new Promise(res => canvasCap.toBlob(res, 'image/png', 0.95));
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
  }

  // Bot칩n: Descargar captura
  downloadBtn.addEventListener('click', async ()=>{
    const blob = await captureCardBlob();
    if (!blob) return;
    const safeText = premio.textContent.trim().replace(/\s+/g,'_').slice(0,40);
    downloadBlob(blob, `premio_${safeText}.png`);
  });

  // Bot칩n: Enviar por WhatsApp
  whatsappBtn.addEventListener('click', async ()=>{
    const mensaje = `춰Hola! Acabo de ganar en la RASPADITA TEAM L-5: ${premio.textContent.trim()}`;
    const blob = await captureCardBlob();
    const waURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;

    // Intento compartir con archivo (m칩viles modernos)
    try{
      if (blob && navigator.canShare && navigator.canShare({ files: [new File([blob], 'premio.png', {type:'image/png'})] })) {
        await navigator.share({
          files: [new File([blob], 'premio.png', {type:'image/png'})],
          title: 'Premio RASPADITA TEAM L-5',
          text: mensaje
        });
        return;
      }
    }catch(e){
      // si falla, sigue con el fallback
    }

    // Fallback: descargar imagen y abrir WhatsApp con texto
    if (blob){
      downloadBlob(blob, 'premio.png');
    }
    window.open(waURL, '_blank');
  });

  window.addEventListener('resize', size);
  window.addEventListener('load', loadFoilAndSize);
  document.addEventListener('DOMContentLoaded', loadFoilAndSize);

  /*
   * Integraci칩n backend (opcional):
   * - Validar c칩digo antes de raspar (POST /api/verificar-codigo)
   * - Enviar confirmaci칩n de reclamo cuando se revele
   */
</script>
</body>
</html>
